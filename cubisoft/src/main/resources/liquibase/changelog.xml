<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">


	<!-- DROP TABLES -->
	<changeSet author="liquibase-docs" id="dropTable-example" runAlways="true">
		<preConditions onFail="MARK_RAN"><tableExists schemaName="cubisoft" tableName="example_entities"/></preConditions>
		<dropTable cascadeConstraints="true"
		        tableName="example_entities"/>
	</changeSet>
	
	<changeSet author="BranLopez"  id="dropLikes" runAlways="true">
		<preConditions onFail="MARK_RAN"><tableExists schemaName="cubisoft" tableName="Likes"/></preConditions>
		<dropTable cascadeConstraints="true"
		        tableName="Likes"/>
	</changeSet>
	
	<changeSet author="PabloRivas" id="dropFollow" runAlways="true">
		<preConditions onFail="MARK_RAN"><tableExists schemaName="cubisoft" tableName="Follow"/></preConditions>
		<dropTable cascadeConstraints="true"
		        tableName="Follow"/>
	</changeSet>
	
	<changeSet author="PabloRivas" id="dropPostTable" runAlways="true">
		<preConditions onFail="MARK_RAN"><tableExists schemaName="cubisoft" tableName="Post"/></preConditions>
		<dropTable cascadeConstraints="true"
		        tableName="Post"/>
	</changeSet>
	
	<changeSet author="PabloRivas" id="dropPicture" runAlways="true">
		<preConditions onFail="MARK_RAN"><tableExists schemaName="cubisoft" tableName="Picture"/></preConditions>
		<dropTable cascadeConstraints="true"
		        tableName="Picture"/>
	</changeSet>
	
	<changeSet author="PabloRivas" id="dropUserProfile" runAlways="true">
		<preConditions onFail="MARK_RAN"><tableExists schemaName="cubisoft" tableName="UserProfile"/></preConditions>
		<dropTable cascadeConstraints="true"
		        tableName="UserProfile"/>
	</changeSet>
	<!-- CreaciÃ³n de tablas -->

	<changeSet author="PabloRivas" id="cubisoft_tables" runAlways="true">
		<createTable tableName="UserProfile">
		     <column autoIncrement="true" name="user_id" type="BIGINT">
		        <constraints primaryKey="true" />
		     </column>
		     <column name="login" type="VARCHAR(30)">
		        <constraints nullable="false" unique="true" />
		     </column>
		     <column name="firstName" type="VARCHAR(30)">
		        <constraints nullable="false" />
		     </column>
		     <column name="lastName" type="VARCHAR(30)">
		        <constraints nullable="false" />
		     </column>
		     <column name="password" type="VARCHAR(60)">
		        <constraints nullable="false" />
		     </column>
		     <column name="email" type="VARCHAR(30)">
		        <constraints nullable="false" unique="true" />
		     </column>
		</createTable>  

		<createTable tableName="Picture">
		     <column autoIncrement="true" name="picture_id" type="BIGINT">
		        <constraints primaryKey="true" />
		     </column>
		     <column name="description" type="VARCHAR(240)"/>      
		     <column name="image_path" type="VARCHAR(200)">
		        <constraints nullable="false" />
		     </column>
		     <column name="date" type="DATETIME">
		        <constraints nullable="false" />
		     </column>
		     <column name="user_id" type="BIGINT">
		         <constraints nullable="false" 
		         	foreignKeyName="fk_user_id" 
                	references="UserProfile(user_id)"
       	            />
		     </column>

		</createTable>
		
		<createTable tableName="Post">
		     <column autoIncrement="true" name="post_id" type="BIGINT">
		        <constraints primaryKey="true" />
		     </column>
		     <column name="date" type="DATETIME">
		        <constraints nullable="false" />
		     </column>

		     <column name="user_id" type="BIGINT">
		         <constraints nullable="false" 
		         	foreignKeyName="post_user_id_fk" 
                	references="UserProfile(user_id)"
       	            />
		     </column>
		     
		     <column name="picture_id" type="BIGINT">
		     	<constraints nullable="false" />
		     </column>
		     
		      <column name="views" type="BIGINT">
		     	<constraints nullable="false" />
		     </column>
		     
		     <column name="number_of_likes" type="BIGINT">
		     	<constraints nullable="false" />
		     </column>
		   
		     <column name="reshare" type="BOOLEAN">
		     	<constraints nullable="false" />
		     </column>
		</createTable>
		
		<createTable tableName="Follow">
		     <column autoIncrement="true" name="follow_id" type="BIGINT">
		        <constraints primaryKey="true" />
		     </column>
		     <column name="user" type="BIGINT">
		         <constraints nullable="false" 
		         	foreignKeyName="follow_user_fk" 
                	references="UserProfile(user_id)"
       	            />
		     </column>
		     <column name="followed_user" type="BIGINT">
		         <constraints nullable="false" 
		         	foreignKeyName="follow_followed_user_fk" 
                	references="UserProfile(user_id)"
       	            />
		     </column>
		</createTable>
		
		<createTable tableName="Likes">
		<column autoIncrement="true" name="likes_id" type="BIGINT">
		        <constraints primaryKey="true" />
		     </column>
		     <column name="user" type="BIGINT">
		         <constraints nullable="false" 
		         	foreignKeyName="like_user_fk" 
                	references="UserProfile(user_id)"
       	            />
		     </column>
		     <column name="post" type="BIGINT">
		         <constraints nullable="false" 
       	            />
		     </column>
		</createTable>
		
	</changeSet>
	<changeSet author="PabloRivas" id="foreign_keys" runAlways="true">
		    <addForeignKeyConstraint baseColumnNames="picture_id"
	            baseTableName="Post"
	            constraintName="post_picture_id_fk"
	            onDelete="CASCADE"
	            onUpdate="RESTRICT"
	            referencedColumnNames="picture_id"
	            referencedTableName="Picture"/>
	            <addForeignKeyConstraint baseColumnNames="post"
	            baseTableName="Likes"
	            constraintName="like_post_id_fk"
	            onDelete="CASCADE"
	            onUpdate="RESTRICT"
	            referencedColumnNames="post_id"
	            referencedTableName="Post"/>	
	</changeSet>
	
	<changeSet author="BranLopez" id="likes_unique_contraint" runAlways="true">
		<addUniqueConstraint
			columnNames="user, post"
			constraintName="like_unique_constraint"
			tableName="Likes"/>
	</changeSet>
	
	<!-- Contenido por defecto -->

   <changeSet author="Bernardo" id="initial_tables" runAlways="true">
      <createTable tableName="example_entities">
         <column autoIncrement="true" name="id" type="BIGINT">
            <constraints primaryKey="true" />
         </column>
         <column name="name" type="VARCHAR(30)">
            <constraints nullable="false" unique="true" />
         </column>
      </createTable>
   </changeSet>

   <changeSet author="Bernardo" id="initial_data" runAlways="true">
      <sqlFile encoding="utf8" path="populate/initial.sql"
         relativeToChangelogFile="true" stripComments="true" />
   </changeSet>

</databaseChangeLog>
